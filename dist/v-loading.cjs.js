'use strict';

const setStyle = (ele, obj) => {
  for (const key of Object.keys(obj)) {
    ele.style[key] = `${obj[key]}`;
  }
};
const getStyle = (ele, attr) => {
  return document.defaultView.getComputedStyle(ele)[attr];
};

const clearBorder = (ele, data, duration = 600) => {
  setStyle(ele, {
    "borderBottom": "0 solid transparent",
    "transition": `border-bottom ${duration}ms`
  });
  setTimeout(() => {
    setStyle(ele, {
      "transition": "none"
    });
    (data) && (data.phase = -1);
  }, duration);
};

const clearHeight = (ele, data, duration = 600) => {
  let color = getStyle(ele, "backgroundColor");
  setStyle(ele, {
    height: "0",
    background: color,
    transition: `height ${duration}ms`
  });
  setTimeout(() => {
    setStyle(ele, {
      "transition": "none"
    });
    (data) && (data.phase = -1);
  }, duration);
};

const clearLoadingImg = (ele) => {
  setStyle(ele, {
    background: "none"
  });
};

const setBorder = (ele, value, color = "#f0f0f0") => {
  setStyle(ele, {
    "borderBottom": `${value}px solid ${color}`,
    transition: "none",
  });
};

const setHeight = (ele, value, color ="#f0f0f0") => {
  setStyle(ele, {
    height: `${value}px`,
    background: color,
    transition: "none"
  });
};

const setLoadingImg = (ele, src="./loading.gif") => {
  let color = getStyle(ele, "backgroundColor");
  setStyle(ele, {
    background: `url(${src}) center/4em no-repeat ${color}`
  });
};

const defaultOptions = {
  max: 80,
  bg: "#f0f0f0",
  cb: () => {},
  stage1Begin: () => {},
  stage2Begin: (ele) => {
    setLoadingImg(ele);
  },
  stage1End: () => {},
  stage2End: () => {
    clearLoadingImg(ele);
  },
  stage2: () => {},
  duration: 250,
};

const updateDataInStart = (data, e, options) => {
  data.start = e.touches[0].pageY;
  (data.phase === -1) && (data.phase = 0);
};
const updateDataInMove = (data, e, options) => {
  let move = e.touches[0].pageY,
    start = data.start,
    ele = options.ele;
  (data.phase === 0) && (data.phase = 1);
  if(data.phase === 1) {
    data.y = move - start;
    data.positive = data.y >= 0;
    data.negative = !data.positive;
    data.top = ele.scrollTop === 0;
    data.bottom = ele.scrollTop + ele.clientHeight === ele.scrollHeight;
  }
};

class VLoading {
  constructor(ele, options) {
    this.ele = ele;
    this.options = Object.assign(defaultOptions, options, { ele });
    this.data = {
      top: false,     // 是否触顶
      bottom: false,  // 是否触底
      y: 0,           // 路程位移
      start: 0,       // 起点位移
      phase: -1,      // 0:touchstart, 1:touchmove, 2:touchend/cancel, -1, no events
    };
    this.insertLoading();
    this.init();
  }
  insertLoading() {
    const loading = this.options.loading;
    if(loading)
      return;
    let firstNode = this.ele.firstElementChild,
      div = document.createElement("div");
    this.ele.insertBefore(div, firstNode);
    this.options.loading = div;
  }
  init() {
    let ele = this.ele,
      data = this.data,
      loading = this.options.loading,
      cb = this.options.cb,
      max = this.options.max,
      bg = this.options.bg,
      duration = this.options.duration,
      stage1Begin = this.options.stage1Begin,
      stage2Begin = this.options.stage2Begin,
      stage1End = this.options.stage1End,
      stage2End = this.options.stage1End;

    ele.addEventListener("touchstart", (e) => {
      updateDataInStart(data, e, this.options);
      // if(data.ing)
      //   return;
      // data.move = true;
      // data.start = e.touches[0].pageY;
    });
    ele.addEventListener("touchmove", (e) => {
      updateDataInMove(data, e, this.options);
      if(data.phase !== 1){
        e.preventDefault();
        return;
      }
      if(data.top) {
        if(data.positive)
          e.preventDefault();
        let y = data.y;
        if(y >= max) {
          y = (y - max) / 2;
          stage2Begin(loading);
          setBorder(loading, y, bg);
        } else {
          stage1Begin(loading);
          setHeight(loading, y, bg);
        }
      }


      // if(!data.move)
      //   return;
      // let move = e.touches[0].pageY,
      //   deltaY = move - data.start;
      // if(ele.scrollTop === 0) {
      //   if(deltaY > 0 || data.ing)
      //     e.preventDefault();
      //   let y = data.y = deltaY
      //   if(y >= max) {
      //     // y = y < (max + 100) ? (y - max) / 4 : (y-max)/2;
      //     y = (y - max) / 2;
      //     stage2Begin(loading);
      //     setBorder(loading, y, bg);
      //   } else {
      //     stage1Begin(loading);
      //     setHeight(loading, y, bg);
      //   }
      // }
    }, {passive: false});
    ele.addEventListener("touchend", (e) => {
      if(data.phase !== 1 )
        return;
      let y = data.y;
        data.phase;
      data.start = data.y = 0;
      data.phase = 2;
      if(y > max) {
        clearBorder(loading,null, duration);
        cb(() => {stage2End(loading);clearHeight(loading, data, duration);});
      } else {
        stage1End(loading);
        data.phase = -1;
        clearBorder(loading, data, duration);
        clearHeight(loading, data, duration);
      }

      // let y = data.y,
      //   move = data.move;
      // data.start = data.y = 0;
      // data.move = false;
      // if(!move)
      //   return;
      // if(y > max) {
      //   clearBorder(loading, duration);
      //   cb(() => {stage2End(loading);clearHeight(loading, duration);data.ing = false;});
      // } else {
      //   stage1End(loading);
      //   data.ing = false;
      //   clearBorder(loading, duration);
      //   clearHeight(loading, duration);
      // }
    });
    ele.addEventListener("touchcancel", (e) => {
    });
  }
}

module.exports = VLoading;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidi1sb2FkaW5nLmNqcy5qcyIsInNvdXJjZXMiOlsiLi4vc3JjL3V0aWxzL2luZGV4LmpzIiwiLi4vc3JjL2NvcmUvZGVmYXVsdC5qcyIsIi4uL3NyYy9jb3JlL2hlbHBlcnMuanMiLCIuLi9zcmMvY29yZS9pbmRleC5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCBzZXRTdHlsZSA9IChlbGUsIG9iaikgPT4ge1xuICBmb3IgKGNvbnN0IGtleSBvZiBPYmplY3Qua2V5cyhvYmopKSB7XG4gICAgZWxlLnN0eWxlW2tleV0gPSBgJHtvYmpba2V5XX1gO1xuICB9XG59XG5jb25zdCBnZXRTdHlsZSA9IChlbGUsIGF0dHIpID0+IHtcbiAgcmV0dXJuIGRvY3VtZW50LmRlZmF1bHRWaWV3LmdldENvbXB1dGVkU3R5bGUoZWxlKVthdHRyXTtcbn1cblxuY29uc3QgY2xlYXJCb3JkZXIgPSAoZWxlLCBkYXRhLCBkdXJhdGlvbiA9IDYwMCkgPT4ge1xuICBzZXRTdHlsZShlbGUsIHtcbiAgICBcImJvcmRlckJvdHRvbVwiOiBcIjAgc29saWQgdHJhbnNwYXJlbnRcIixcbiAgICBcInRyYW5zaXRpb25cIjogYGJvcmRlci1ib3R0b20gJHtkdXJhdGlvbn1tc2BcbiAgfSlcbiAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgc2V0U3R5bGUoZWxlLCB7XG4gICAgICBcInRyYW5zaXRpb25cIjogXCJub25lXCJcbiAgICB9KTtcbiAgICAoZGF0YSkgJiYgKGRhdGEucGhhc2UgPSAtMSk7XG4gIH0sIGR1cmF0aW9uKVxufVxuXG5jb25zdCBjbGVhckhlaWdodCA9IChlbGUsIGRhdGEsIGR1cmF0aW9uID0gNjAwKSA9PiB7XG4gIGxldCBjb2xvciA9IGdldFN0eWxlKGVsZSwgXCJiYWNrZ3JvdW5kQ29sb3JcIik7XG4gIHNldFN0eWxlKGVsZSwge1xuICAgIGhlaWdodDogXCIwXCIsXG4gICAgYmFja2dyb3VuZDogY29sb3IsXG4gICAgdHJhbnNpdGlvbjogYGhlaWdodCAke2R1cmF0aW9ufW1zYFxuICB9KVxuICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICBzZXRTdHlsZShlbGUsIHtcbiAgICAgIFwidHJhbnNpdGlvblwiOiBcIm5vbmVcIlxuICAgIH0pO1xuICAgIChkYXRhKSAmJiAoZGF0YS5waGFzZSA9IC0xKTtcbiAgfSwgZHVyYXRpb24pXG59XG5cbmNvbnN0IGNsZWFyTG9hZGluZ0ltZyA9IChlbGUpID0+IHtcbiAgc2V0U3R5bGUoZWxlLCB7XG4gICAgYmFja2dyb3VuZDogXCJub25lXCJcbiAgfSlcbn1cblxuY29uc3Qgc2V0Qm9yZGVyID0gKGVsZSwgdmFsdWUsIGNvbG9yID0gXCIjZjBmMGYwXCIpID0+IHtcbiAgc2V0U3R5bGUoZWxlLCB7XG4gICAgXCJib3JkZXJCb3R0b21cIjogYCR7dmFsdWV9cHggc29saWQgJHtjb2xvcn1gLFxuICAgIHRyYW5zaXRpb246IFwibm9uZVwiLFxuICB9KVxufVxuXG5jb25zdCBzZXRIZWlnaHQgPSAoZWxlLCB2YWx1ZSwgY29sb3IgPVwiI2YwZjBmMFwiKSA9PiB7XG4gIHNldFN0eWxlKGVsZSwge1xuICAgIGhlaWdodDogYCR7dmFsdWV9cHhgLFxuICAgIGJhY2tncm91bmQ6IGNvbG9yLFxuICAgIHRyYW5zaXRpb246IFwibm9uZVwiXG4gIH0pXG59XG5cbmNvbnN0IHNldExvYWRpbmdJbWcgPSAoZWxlLCBzcmM9XCIuL2xvYWRpbmcuZ2lmXCIpID0+IHtcbiAgbGV0IGNvbG9yID0gZ2V0U3R5bGUoZWxlLCBcImJhY2tncm91bmRDb2xvclwiKTtcbiAgc2V0U3R5bGUoZWxlLCB7XG4gICAgYmFja2dyb3VuZDogYHVybCgke3NyY30pIGNlbnRlci80ZW0gbm8tcmVwZWF0ICR7Y29sb3J9YFxuICB9KVxufVxuXG5jb25zdCBkYW1wID0gKHgsIG1heCkgPT4ge1xuICBsZXQgdW5pdCA9ICh4KSA9PiB7XG4gICAgcmV0dXJuIE1hdGguYXRhbih4KSAvIChNYXRoLlBJIC8gMik7XG4gIH1cbiAgbGV0IGNvbnRyYWN0aW9uID0gKHgsIG1heCkgPT4ge1xuICAgIHJldHVybiB4IC8gbWF4O1xuICB9XG4gIHJldHVybiB1bml0KGNvbnRyYWN0aW9uKHgsIG1heCkpICogbWF4O1xufVxuZXhwb3J0IHtcbiAgc2V0U3R5bGUsXG4gIHNldEhlaWdodCxcbiAgc2V0Qm9yZGVyLFxuICBjbGVhckhlaWdodCxcbiAgY2xlYXJCb3JkZXIsXG4gIGRhbXAsXG4gIHNldExvYWRpbmdJbWcsXG4gIGNsZWFyTG9hZGluZ0ltZ1xufVxuIiwiaW1wb3J0IHtjbGVhckxvYWRpbmdJbWcsIHNldExvYWRpbmdJbWd9IGZyb20gXCIuLi91dGlsc1wiO1xuXG5jb25zdCBkZWZhdWx0T3B0aW9ucyA9IHtcbiAgbWF4OiA4MCxcbiAgYmc6IFwiI2YwZjBmMFwiLFxuICBjYjogKCkgPT4ge30sXG4gIHN0YWdlMUJlZ2luOiAoKSA9PiB7fSxcbiAgc3RhZ2UyQmVnaW46IChlbGUpID0+IHtcbiAgICBzZXRMb2FkaW5nSW1nKGVsZSlcbiAgfSxcbiAgc3RhZ2UxRW5kOiAoKSA9PiB7fSxcbiAgc3RhZ2UyRW5kOiAoKSA9PiB7XG4gICAgY2xlYXJMb2FkaW5nSW1nKGVsZSlcbiAgfSxcbiAgc3RhZ2UyOiAoKSA9PiB7fSxcbiAgZHVyYXRpb246IDI1MCxcbn1cbmV4cG9ydCB7XG4gIGRlZmF1bHRPcHRpb25zXG59XG4iLCJjb25zdCB1cGRhdGVEYXRhSW5TdGFydCA9IChkYXRhLCBlLCBvcHRpb25zKSA9PiB7XG4gIGRhdGEuc3RhcnQgPSBlLnRvdWNoZXNbMF0ucGFnZVk7XG4gIChkYXRhLnBoYXNlID09PSAtMSkgJiYgKGRhdGEucGhhc2UgPSAwKTtcbn1cbmNvbnN0IHVwZGF0ZURhdGFJbk1vdmUgPSAoZGF0YSwgZSwgb3B0aW9ucykgPT4ge1xuICBsZXQgbW92ZSA9IGUudG91Y2hlc1swXS5wYWdlWSxcbiAgICBzdGFydCA9IGRhdGEuc3RhcnQsXG4gICAgZWxlID0gb3B0aW9ucy5lbGU7XG4gIChkYXRhLnBoYXNlID09PSAwKSAmJiAoZGF0YS5waGFzZSA9IDEpO1xuICBpZihkYXRhLnBoYXNlID09PSAxKSB7XG4gICAgZGF0YS55ID0gbW92ZSAtIHN0YXJ0O1xuICAgIGRhdGEucG9zaXRpdmUgPSBkYXRhLnkgPj0gMDtcbiAgICBkYXRhLm5lZ2F0aXZlID0gIWRhdGEucG9zaXRpdmU7XG4gICAgZGF0YS50b3AgPSBlbGUuc2Nyb2xsVG9wID09PSAwO1xuICAgIGRhdGEuYm90dG9tID0gZWxlLnNjcm9sbFRvcCArIGVsZS5jbGllbnRIZWlnaHQgPT09IGVsZS5zY3JvbGxIZWlnaHQ7XG4gIH1cbn1cblxuY29uc3QgdXBkYXRlRGF0YUluQ2FuY2VsID0gKGRhdGEsIGUsIG9wdGlvbnMpID0+IHtcbiAgKGRhdGEucGhhc2UgPT09IDEpICYmIChkYXRhLnBoYXNlID0gMik7XG5cbn1cbmV4cG9ydCB7XG4gIHVwZGF0ZURhdGFJblN0YXJ0LFxuICB1cGRhdGVEYXRhSW5Nb3ZlLFxuICB1cGRhdGVEYXRhSW5DYW5jZWxcbn1cbiIsImltcG9ydCB7ZGVmYXVsdE9wdGlvbnN9IGZyb20gXCIuL2RlZmF1bHRcIjtcbmltcG9ydCB7Y2xlYXJCb3JkZXIsIGNsZWFySGVpZ2h0LCBjbGVhckxvYWRpbmdJbWcsIHNldEJvcmRlciwgc2V0SGVpZ2h0LCBzZXRMb2FkaW5nSW1nLCBkYW1wfSBmcm9tIFwiLi4vdXRpbHMvaW5kZXhcIjtcbmltcG9ydCB7XG4gIHVwZGF0ZURhdGFJblN0YXJ0LFxuICB1cGRhdGVEYXRhSW5Nb3ZlLFxuICB1cGRhdGVEYXRhSW5DYW5jZWxcbn0gZnJvbSBcIi4vaGVscGVyc1wiO1xuXG5jbGFzcyBWTG9hZGluZyB7XG4gIGNvbnN0cnVjdG9yKGVsZSwgb3B0aW9ucykge1xuICAgIHRoaXMuZWxlID0gZWxlO1xuICAgIHRoaXMub3B0aW9ucyA9IE9iamVjdC5hc3NpZ24oZGVmYXVsdE9wdGlvbnMsIG9wdGlvbnMsIHsgZWxlIH0pO1xuICAgIHRoaXMuZGF0YSA9IHtcbiAgICAgIHRvcDogZmFsc2UsICAgICAvLyDmmK/lkKbop6bpobZcbiAgICAgIGJvdHRvbTogZmFsc2UsICAvLyDmmK/lkKbop6blupVcbiAgICAgIHk6IDAsICAgICAgICAgICAvLyDot6/nqIvkvY3np7tcbiAgICAgIHN0YXJ0OiAwLCAgICAgICAvLyDotbfngrnkvY3np7tcbiAgICAgIHBoYXNlOiAtMSwgICAgICAvLyAwOnRvdWNoc3RhcnQsIDE6dG91Y2htb3ZlLCAyOnRvdWNoZW5kL2NhbmNlbCwgLTEsIG5vIGV2ZW50c1xuICAgIH1cbiAgICB0aGlzLmluc2VydExvYWRpbmcoKTtcbiAgICB0aGlzLmluaXQoKTtcbiAgfVxuICBpbnNlcnRMb2FkaW5nKCkge1xuICAgIGNvbnN0IGxvYWRpbmcgPSB0aGlzLm9wdGlvbnMubG9hZGluZztcbiAgICBpZihsb2FkaW5nKVxuICAgICAgcmV0dXJuO1xuICAgIGxldCBmaXJzdE5vZGUgPSB0aGlzLmVsZS5maXJzdEVsZW1lbnRDaGlsZCxcbiAgICAgIGRpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJkaXZcIik7XG4gICAgdGhpcy5lbGUuaW5zZXJ0QmVmb3JlKGRpdiwgZmlyc3ROb2RlKTtcbiAgICB0aGlzLm9wdGlvbnMubG9hZGluZyA9IGRpdjtcbiAgfVxuICBpbml0KCkge1xuICAgIGxldCBlbGUgPSB0aGlzLmVsZSxcbiAgICAgIGRhdGEgPSB0aGlzLmRhdGEsXG4gICAgICBsb2FkaW5nID0gdGhpcy5vcHRpb25zLmxvYWRpbmcsXG4gICAgICBjYiA9IHRoaXMub3B0aW9ucy5jYixcbiAgICAgIG1heCA9IHRoaXMub3B0aW9ucy5tYXgsXG4gICAgICBiZyA9IHRoaXMub3B0aW9ucy5iZyxcbiAgICAgIGR1cmF0aW9uID0gdGhpcy5vcHRpb25zLmR1cmF0aW9uLFxuICAgICAgc3RhZ2UxQmVnaW4gPSB0aGlzLm9wdGlvbnMuc3RhZ2UxQmVnaW4sXG4gICAgICBzdGFnZTJCZWdpbiA9IHRoaXMub3B0aW9ucy5zdGFnZTJCZWdpbixcbiAgICAgIHN0YWdlMUVuZCA9IHRoaXMub3B0aW9ucy5zdGFnZTFFbmQsXG4gICAgICBzdGFnZTJFbmQgPSB0aGlzLm9wdGlvbnMuc3RhZ2UxRW5kO1xuXG4gICAgZWxlLmFkZEV2ZW50TGlzdGVuZXIoXCJ0b3VjaHN0YXJ0XCIsIChlKSA9PiB7XG4gICAgICB1cGRhdGVEYXRhSW5TdGFydChkYXRhLCBlLCB0aGlzLm9wdGlvbnMpO1xuICAgICAgLy8gaWYoZGF0YS5pbmcpXG4gICAgICAvLyAgIHJldHVybjtcbiAgICAgIC8vIGRhdGEubW92ZSA9IHRydWU7XG4gICAgICAvLyBkYXRhLnN0YXJ0ID0gZS50b3VjaGVzWzBdLnBhZ2VZO1xuICAgIH0pXG4gICAgZWxlLmFkZEV2ZW50TGlzdGVuZXIoXCJ0b3VjaG1vdmVcIiwgKGUpID0+IHtcbiAgICAgIHVwZGF0ZURhdGFJbk1vdmUoZGF0YSwgZSwgdGhpcy5vcHRpb25zKTtcbiAgICAgIGlmKGRhdGEucGhhc2UgIT09IDEpe1xuICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cbiAgICAgIGlmKGRhdGEudG9wKSB7XG4gICAgICAgIGlmKGRhdGEucG9zaXRpdmUpXG4gICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICBsZXQgeSA9IGRhdGEueTtcbiAgICAgICAgaWYoeSA+PSBtYXgpIHtcbiAgICAgICAgICB5ID0gKHkgLSBtYXgpIC8gMjtcbiAgICAgICAgICBzdGFnZTJCZWdpbihsb2FkaW5nKTtcbiAgICAgICAgICBzZXRCb3JkZXIobG9hZGluZywgeSwgYmcpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHN0YWdlMUJlZ2luKGxvYWRpbmcpO1xuICAgICAgICAgIHNldEhlaWdodChsb2FkaW5nLCB5LCBiZyk7XG4gICAgICAgIH1cbiAgICAgIH1cblxuXG4gICAgICAvLyBpZighZGF0YS5tb3ZlKVxuICAgICAgLy8gICByZXR1cm47XG4gICAgICAvLyBsZXQgbW92ZSA9IGUudG91Y2hlc1swXS5wYWdlWSxcbiAgICAgIC8vICAgZGVsdGFZID0gbW92ZSAtIGRhdGEuc3RhcnQ7XG4gICAgICAvLyBpZihlbGUuc2Nyb2xsVG9wID09PSAwKSB7XG4gICAgICAvLyAgIGlmKGRlbHRhWSA+IDAgfHwgZGF0YS5pbmcpXG4gICAgICAvLyAgICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgLy8gICBsZXQgeSA9IGRhdGEueSA9IGRlbHRhWVxuICAgICAgLy8gICBpZih5ID49IG1heCkge1xuICAgICAgLy8gICAgIC8vIHkgPSB5IDwgKG1heCArIDEwMCkgPyAoeSAtIG1heCkgLyA0IDogKHktbWF4KS8yO1xuICAgICAgLy8gICAgIHkgPSAoeSAtIG1heCkgLyAyO1xuICAgICAgLy8gICAgIHN0YWdlMkJlZ2luKGxvYWRpbmcpO1xuICAgICAgLy8gICAgIHNldEJvcmRlcihsb2FkaW5nLCB5LCBiZyk7XG4gICAgICAvLyAgIH0gZWxzZSB7XG4gICAgICAvLyAgICAgc3RhZ2UxQmVnaW4obG9hZGluZyk7XG4gICAgICAvLyAgICAgc2V0SGVpZ2h0KGxvYWRpbmcsIHksIGJnKTtcbiAgICAgIC8vICAgfVxuICAgICAgLy8gfVxuICAgIH0sIHtwYXNzaXZlOiBmYWxzZX0pXG4gICAgZWxlLmFkZEV2ZW50TGlzdGVuZXIoXCJ0b3VjaGVuZFwiLCAoZSkgPT4ge1xuICAgICAgaWYoZGF0YS5waGFzZSAhPT0gMSApXG4gICAgICAgIHJldHVybjtcbiAgICAgIGxldCB5ID0gZGF0YS55LFxuICAgICAgICBwaGFzZSA9IGRhdGEucGhhc2U7XG4gICAgICBkYXRhLnN0YXJ0ID0gZGF0YS55ID0gMDtcbiAgICAgIGRhdGEucGhhc2UgPSAyO1xuICAgICAgaWYoeSA+IG1heCkge1xuICAgICAgICBjbGVhckJvcmRlcihsb2FkaW5nLG51bGwsIGR1cmF0aW9uKTtcbiAgICAgICAgY2IoKCkgPT4ge3N0YWdlMkVuZChsb2FkaW5nKTtjbGVhckhlaWdodChsb2FkaW5nLCBkYXRhLCBkdXJhdGlvbil9KTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHN0YWdlMUVuZChsb2FkaW5nKTtcbiAgICAgICAgZGF0YS5waGFzZSA9IC0xO1xuICAgICAgICBjbGVhckJvcmRlcihsb2FkaW5nLCBkYXRhLCBkdXJhdGlvbik7XG4gICAgICAgIGNsZWFySGVpZ2h0KGxvYWRpbmcsIGRhdGEsIGR1cmF0aW9uKTtcbiAgICAgIH1cblxuICAgICAgLy8gbGV0IHkgPSBkYXRhLnksXG4gICAgICAvLyAgIG1vdmUgPSBkYXRhLm1vdmU7XG4gICAgICAvLyBkYXRhLnN0YXJ0ID0gZGF0YS55ID0gMDtcbiAgICAgIC8vIGRhdGEubW92ZSA9IGZhbHNlO1xuICAgICAgLy8gaWYoIW1vdmUpXG4gICAgICAvLyAgIHJldHVybjtcbiAgICAgIC8vIGlmKHkgPiBtYXgpIHtcbiAgICAgIC8vICAgY2xlYXJCb3JkZXIobG9hZGluZywgZHVyYXRpb24pO1xuICAgICAgLy8gICBjYigoKSA9PiB7c3RhZ2UyRW5kKGxvYWRpbmcpO2NsZWFySGVpZ2h0KGxvYWRpbmcsIGR1cmF0aW9uKTtkYXRhLmluZyA9IGZhbHNlO30pO1xuICAgICAgLy8gfSBlbHNlIHtcbiAgICAgIC8vICAgc3RhZ2UxRW5kKGxvYWRpbmcpO1xuICAgICAgLy8gICBkYXRhLmluZyA9IGZhbHNlO1xuICAgICAgLy8gICBjbGVhckJvcmRlcihsb2FkaW5nLCBkdXJhdGlvbik7XG4gICAgICAvLyAgIGNsZWFySGVpZ2h0KGxvYWRpbmcsIGR1cmF0aW9uKTtcbiAgICAgIC8vIH1cbiAgICB9KVxuICAgIGVsZS5hZGRFdmVudExpc3RlbmVyKFwidG91Y2hjYW5jZWxcIiwgKGUpID0+IHtcbiAgICB9KVxuICB9XG59XG5leHBvcnQgZGVmYXVsdCBWTG9hZGluZztcbiJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLE1BQU0sUUFBUSxHQUFHLENBQUMsR0FBRyxFQUFFLEdBQUcsS0FBSztBQUMvQixFQUFFLEtBQUssTUFBTSxHQUFHLElBQUksTUFBTSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRTtBQUN0QyxJQUFJLEdBQUcsQ0FBQyxLQUFL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
